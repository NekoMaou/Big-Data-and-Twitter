<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Map Test</title>
		<!--<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
		(todo: get an icon)-->
		<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
		<link rel="stylesheet" href="static/css/gmaps-sidebar.css" />
		<style type="text/css">
			html, body, #map-canvas {
				height: 100%;
				margin: 0;
				padding: 0;
			}

			.controls {
				margin-top: 16px;
				border: 1px solid transparent;
				border-radius: 2px 0 0 2px;
				box-sizing: border-box;
				-moz-box-sizing: border-box;
				outline: none;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
			}

			#pac-input {
				background-color: #fff;
				font-family: Roboto;
				font-size: 15px;
				font-weight: 300;
				margin-left: 12px;
				padding: 0 11px 0 13px;
				text-overflow: ellipsis;
				width: 400px;
			}

			#pac-input:focus {
				border-color: #4d90fe;
			}

			.pac-container {
				font-family: Roboto;
			}

			#overlay {
				background-color: #fff;
				font-family: Roboto;
				font-size: 15px;
				margin-left: 12px;
				margin-bottom: 30px;
				padding: 5px 11px 5px 13px;
				text-overflow: ellipsis;
				width: 400px;
			}

			img {
				vertical-align: middle;
			}
		</style>
		<!--<script type="text/javascript"
			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZ1QG7SEdSi66Tr0IE5ehHUpnoAbEQcnE">
		</script>-->
	</head>
	<body>
		<input id="pac-input" class="controls" type="text" placeholder="Search Box">
		<div id="overlay" class="controls">
			<div id="language"></div>
			<div id="word-cloud"></div>
		</div>

		<div id="sidebar" class="sidebar collapsed">
			<!-- Nav tabs -->
			<ul class="sidebar-tabs" role="tablist">
				<li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
				<li><a href="#profile" role="tab"><i class="fa fa-user"></i></a></li>
				<li><a href="#messages" role="tab"><i class="fa fa-envelope"></i></a></li>
				<li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
			</ul>

			<!-- Tab panes -->
			<div class="sidebar-content active">
				<div class="sidebar-pane" id="home">
					<h1>sidebar-v2</h1>

					<p>A responsive sidebar for mapping libraries like <a href="http://leafletjs.com/">Leaflet</a> or <a href="http://openlayers.org/">OpenLayers</a>.</p>

					<p class="lorem">Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p>

					<p class="lorem">Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p>

					<p class="lorem">Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p>

					<p class="lorem">Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p>
				</div>
				<div class="sidebar-pane" id="profile"><h1>Profile</h1></div>
				<div class="sidebar-pane" id="messages"><h1>Messages</h1></div>
				<div class="sidebar-pane" id="settings"><h1>Settings</h1></div>
			</div>
		</div>

		<div id="map-canvas"></div>

	<script src="https://maps.googleapis.com/maps/api/js?v=3&libraries=places"></script>
	<script src="static/js/jquery-2.1.3.min.js"></script>
	<script src="static/js/jquery-sidebar.js"></script>

	<script type="text/javascript">
		var input = document.getElementById('pac-input');
		var overlay = document.getElementById('overlay');

		var initializeMap = function() {

			var styles = [
				{
					"featureType": "road",
					"elementType": "geometry",
					"stylers": [
						{ "hue": "#cc00ff" },
						{ "saturation": -74 },
						{ "lightness": 23 }
					]
				},{
					"featureType": "landscape",
					"stylers": [
						{ "saturation": -100 },
						{ "lightness": 50 }
					]
				},{
					"featureType": "poi",
					"elementType": "geometry",
					"stylers": [
						{ "hue": "#55ff00" },
						{ "saturation": 67 }
					]
				},{
					"featureType": "transit",
					"stylers": [
						{ "visibility": "off" }
					]
				},{
					"featureType": "water",
					"stylers": [
						{ "hue": "#0077ff" }
					]
				},{
					"featureType": "road",
					"elementType": "labels",
					"stylers": [
						{ "visibility": "off" }
					]
				},{
					"featureType": "road.highway",
					"stylers": [
						{ "lightness": 21 }
					]
				}
			];

			var mapOptions = {
				center: {
					lat: 51.507222,
					lng: -0.1275
				}, zoom: 10,
				disableDefaultUI: true,
				styles: styles
			};

			var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

			map.data.loadGeoJson("/languageslocations/-180/-90/180/90")

			var flags = {
				"en": "/static/img/flag-en.png",
				"fr": "/static/img/flag-fr.png"
			}

			map.data.setStyle( function(feature) {
				var lang = feature.getProperty('language');
				var icon = "/static/img/dot.png";
				if (lang in flags) icon = flags[lang];
				return { 'icon': icon };
			});

			map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
			map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(overlay);

			var lastBounds = false;
			function updateLocation() {
				//AJAX(map.getBounds().toString(),loadData)
				//check its to the last time to avoid unnecessary loads
				// could also ignore small changes

				if (lastBounds != map.getBounds()) {
					lastBounds = map.getBounds();
					sw = lastBounds.getSouthWest();
					ne = lastBounds.getNorthEast();

					$.get("/languages/" + sw.lng() + "/" + sw.lat() + "/" + ne.lng() + "/" + ne.lat(), function(response) {
						data = response.data;
						// Sort by tweet count
						data.sort(function(a, b) {
							return b[1] - a[1];
						});

						tweetsCount = 0;
						for (var i = 0; i < data.length; i++) {
							tweetsCount += data[i][1];
						}

						var languageShareHtml = "";
						for (var i = 0; i < data.length; i++) {
							languageId = data[i][0];
							languageTweetsCount = data[i][1];
							languageTweetsShare = (languageTweetsCount * 100 / tweetsCount).toFixed(1);

							var languageShareDisplay = " <img src=" + flags[languageId] + " alt=" +
							languageId + "></img>:" + languageTweetsShare + "%";

							if (!(languageId in flags)) {
								languageShareDisplay = " " + languageId + ": " + languageTweetsShare + "%";
							}

							languageShareHtml += languageShareDisplay;
						}
						$("#language").html(languageShareHtml);
					});

					$.get("/words/" + sw.lng() + "/" + sw.lat() + "/" + ne.lng() + "/" + ne.lat() + "/20", function(response) {
						var words = response.words;
						var word_cloud = "";
						for (var i = 0; i < words.length; i++) {
							word_cloud += words[i].word + ": " + words[i].count + "; ";
						}
						$("#word-cloud").html(word_cloud);
					});
				}
			}

			//updateLocation()
			google.maps.event.addListener(map, 'bounds_changed', updateLocation)
			//temporarily ignore the sheer number of requests that would get sent here

			//Search box, code from https://developers.google.com/maps/documentation/javascript/examples/places-autocomplete

			var autocomplete = new google.maps.places.Autocomplete(input);
			autocomplete.bindTo('bounds', map);

			var infowindow = new google.maps.InfoWindow();

			google.maps.event.addListener(autocomplete, 'place_changed', function() {
				infowindow.close();
				var place = autocomplete.getPlace();
				if (!place.geometry) {
					return;
				}

				// If the place has a geometry, then present it on a map.
				if (place.geometry.viewport) {
					map.fitBounds(place.geometry.viewport);
				} else {
					map.setCenter(place.geometry.location);
				}
				map.setZoom(10);
			});

			var sidebar = $('#sidebar').sidebar();

		}

		google.maps.event.addDomListener(window, 'load', initializeMap);

	</script>
	</body>
</html>
