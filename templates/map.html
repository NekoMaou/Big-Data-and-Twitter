<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Map Test</title>
		<!--<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
		(todo: get an icon)-->
		<style type="text/css">
			html, body, #map-canvas {
				height: 100%;
				margin: 0;
				padding: 0;
			}

			.controls {
				margin-top: 16px;
				border: 1px solid transparent;
				border-radius: 2px 0 0 2px;
				box-sizing: border-box;
				-moz-box-sizing: border-box;
				outline: none;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
			}

			#pac-input {
				background-color: #fff;
				font-family: Roboto;
				font-size: 15px;
				font-weight: 300;
				margin-left: 12px;
				padding: 0 11px 0 13px;
				text-overflow: ellipsis;
				width: 400px;
			}

			#pac-input:focus {
				border-color: #4d90fe;
			}

			.pac-container {
				font-family: Roboto;
			}

			#language {
				background-color: #fff;
				font-family: Roboto;
				font-size: 15px;
				margin-left: 12px;
				margin-bottom: 30px;
				padding: 5px 11px 5px 13px;
				text-overflow: ellipsis;
				width: 400px;
			}

			img {
				vertical-align:middle;
			}
		</style>
		<!--<script type="text/javascript"
			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZ1QG7SEdSi66Tr0IE5ehHUpnoAbEQcnE">
		</script>-->
		<script src="https://maps.googleapis.com/maps/api/js?v=3&libraries=places"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	</head>
	<body>
		<input id="pac-input" class="controls" type="text" placeholder="Search Box">
		<div id="language" class="controls">frog box</div>
		<div id="map-canvas"></div>

	</body>
	<script type="text/javascript">

		input = (document.getElementById('pac-input'));
		langbox = document.getElementById('language')

		var mapOptions = {
			center: {
				lat: 51.48,
				lng: 0
			}, zoom: 2,
			disableDefaultUI: true
		};
		map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

		//This data should be loaded from somewhere
		languageTweetsNotLoaded = false;
		languageTweetsNotReady = true
		/*langs={"type": "FeatureCollection","features":[
			{"type": "Feature",
				"properties":{"language":"en"},
				"geometry": {"type": "Point","coordinates": [0, 0]}
			},
			{"type": "Feature",
				"properties":{"language":"fr"},
				"geometry": {"type": "Point","coordinates": [10, 50]}
			}
		]}*/
		langs = {
			"type": "FeatureCollection",
			"features": []
		}
		$.get("/languageslocations/-180/-90/180/90", loadTweetsLocations)

		function loadTweetsLocations(value) {
				langs = {
					"type": "FeatureCollection",
					"features": value.data
				};
				languageTweetsNotReady = false;
		}

		flags={
			'en': 'http://upload.wikimedia.org/wikipedia/en/thumb/a/ae/Flag_of_the_United_Kingdom.svg/40px-Flag_of_the_United_Kingdom.svg.png',
			'fr': 'http://upload.wikimedia.org/wikipedia/en/thumb/c/c3/Flag_of_France.svg/30px-Flag_of_France.svg.png'
		}

		//the bit drawing flags onto the map
		map.data.addGeoJson(langs)
		//map.data.loadGeoJson(url)
		map.data.setStyle(function(feature) {
			var lang = feature.getProperty('language');
			console.log(lang);
			return {
				'icon':flags[lang]
			};
		});

		lastBounds = false;
		function updateLocation() {
			if (languageTweetsNotLoaded != 1) {
				if (languageTweetsNotReady != 1) {
					map.data.addGeoJson(langs);
					languageTweetsNotReady = 1;
				}
			}
			//AJAX(map.getBounds().toString(),loadData)
			//check its to the last time to avoid unnecessary loads
			// could also ignore small changes
			if (lastBounds != map.getBounds()) {
				lastBounds = map.getBounds();
				sw = map.getBounds().getSouthWest();
				ne = map.getBounds().getNorthEast();
				$.get("/languages/" + sw.lng() + "/" + sw.lat() + "/" + ne.lng() + "/" + ne.lat(), function(stuff) {
					//watch out, some combination of flask and jquery are causing this to this to give actual javascript objects, rather than strings as I(Toby) was expecting
					// Ans: javascript loads the JSON as an object not as a string (Paul)
					console.log(stuff);
					data = stuff.data;
					data.sort(function(a, b) {
						return b[1] - a[1];
					});
					tweetsCount = 0;
					for (var i = 0; i < data.length; i++) {
						tweetsCount += data[i][1];
					}
					langbox.innerHTML = "";
					for (var i = 0; i < data.length; i++) {
						lang = data[i][0]
						percent = (data[i][1] * 100 / tweetsCount).toFixed(1)
						var languageShareDisplay = " <img src=" + flags[lang] + ' alt=" + lang + "></img>:' + percent + "%";
						if (!(lang in flags)) {
							languageShareDisplay = " " + lang + ": " + percent + "%";
						}
						langbox.innerHTML += languageShareDisplay;
					}
				});
			}
		}


		//updateLocation()
		google.maps.event.addListener(map, 'bounds_changed', updateLocation)
		//temporarily ignore the sheer number of requests that would get sent here



		//Search box, code from https://developers.google.com/maps/documentation/javascript/examples/places-autocomplete

		map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
		map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(langbox);

		var autocomplete = new google.maps.places.Autocomplete(input);
		autocomplete.bindTo('bounds', map);

		var infowindow = new google.maps.InfoWindow();

		google.maps.event.addListener(autocomplete, 'place_changed', function() {
			infowindow.close();
			var place = autocomplete.getPlace();
			if (!place.geometry) {
				return;
			}

			// If the place has a geometry, then present it on a map.
			if (place.geometry.viewport) {
				map.fitBounds(place.geometry.viewport);
			} else {
				map.setCenter(place.geometry.location);
			}
			map.setZoom(10);
		});
	</script>
</html>
